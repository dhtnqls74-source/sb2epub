<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT to EPUB 변환기</title>
    <!-- Tailwind CSS CDN을 포함하여 빠르게 스타일링합니다. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            max-width: 32rem;
        }
        .file-upload-label {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* 로딩 스피너 애니메이션 */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="container bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 text-center mx-auto my-auto">
        <h1 class="text-2xl sm:text-3xl font-bold mb-4">
            TXT 파일을 EPUB으로 변환하기
        </h1>
        <p class="text-sm sm:text-base text-gray-600 mb-6">
            변환하려는 .txt 파일을 선택하세요.
        </p>

        <!-- 파일 업로드 버튼 -->
        <label for="txt-file-upload" class="file-upload-label inline-block bg-blue-500 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-blue-600">
            TXT 파일 선택
        </label>
        <input id="txt-file-upload" type="file" accept=".txt" class="hidden" />

        <!-- 상태 메시지 및 로딩 스피너 -->
        <div id="status-area" class="mt-8 flex flex-col items-center">
            <!-- 상태 메시지 표시 -->
            <div id="message-box" class="hidden p-4 rounded-xl text-sm w-full"></div>
            
            <!-- 로딩 스피너 -->
            <div id="loading-spinner" class="spinner hidden mt-4"></div>

            <!-- 다운로드 링크가 여기에 표시됩니다. -->
            <div id="download-link-container" class="hidden mt-6"></div>
        </div>

        <!-- EPUB 설정 및 미리보기 컨테이너 -->
        <div id="main-container" class="hidden mt-8 text-left w-full">
            <!-- 파일 미리보기 섹션 -->
            <div class="bg-gray-100 p-4 rounded-xl mb-6">
                <h2 class="text-xl font-bold mb-2">📄 파일 미리보기</h2>
                <textarea id="preview-area" rows="10" class="w-full p-2 border rounded-md resize-none bg-white text-sm" readonly></textarea>
            </div>

            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center">📚EPUB 설정</h2>
            
            <!-- 표지 이미지 선택 -->
            <div class="mb-6">
                <p class="text-gray-600 mb-2">EPUB 표지 이미지 선택</p>
                <label for="cover-image-upload" class="file-upload-label inline-block bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow-sm hover:bg-gray-300">
                    이미지 선택
                </label>
                <input id="cover-image-upload" type="file" accept="image/*" class="hidden" />
                <div id="cover-preview-container" class="mt-4 p-4 bg-gray-100 rounded-xl hidden">
                    <p class="font-bold mb-2">선택된 표지 이미지:</p>
                    <img id="cover-preview" class="w-full h-auto rounded-lg shadow-md max-h-80 object-contain mx-auto" src="" alt="표지 미리보기" />
                </div>
            </div>

            <!-- 목차 설정 -->
            <div class="mb-6">
                <p class="text-gray-600 mb-2">목차 설정</p>
                <textarea id="toc-input" rows="5" class="w-full p-4 border rounded-xl shadow-sm text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="챕터 제목을 한 줄씩 입력하세요.&#10;예:&#10;1장. 새로운 시작&#10;2장. 모험의 서막&#10;3장. 신비한 여정"></textarea>
            </div>

            <!-- EPUB 스타일 설정 -->
            <div class="mb-6">
                <p class="text-gray-600 mb-2">EPUB CSS 스타일 설정</p>
                <textarea id="css-input" rows="8" class="w-full p-4 border rounded-xl shadow-sm text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="/* CSS 코드를 여기에 입력하세요. */">
@page {
  margin: 0;
  padding: 0;
}
body {
  margin: 0;
  padding: 0;
}
h1 {
  font-size: 15pt;
  font-weight: bold;
  text-align: center;
  margin-top: 3em;
  margin-bottom: 3em;
}

p {
  line-height: 2em;
  text-align: justify;
  text-indent: 1em;
  font-size: 1.0em;
  font-weight: normal;
  padding-bottom: 0.4em;
}

.star-separator {
  text-align: center;
  font-weight: bold;
}
</textarea>
            </div>
            
            <!-- 최종 변환 버튼 -->
            <button id="convert-button" class="w-full mt-4 bg-green-500 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-green-600 transition-colors">
                EPUB 변환하기
            </button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // DOM 요소 가져오기
        const txtFileInput = document.getElementById('txt-file-upload');
        const previewArea = document.getElementById('preview-area');
        const coverImageInput = document.getElementById('cover-image-upload');
        const coverPreviewContainer = document.getElementById('cover-preview-container');
        const coverPreview = document.getElementById('cover-preview');
        const tocInput = document.getElementById('toc-input');
        const statusArea = document.getElementById('status-area');
        const messageBox = document.getElementById('message-box');
        const loadingSpinner = document.getElementById('loading-spinner');
        const downloadLinkContainer = document.getElementById('download-link-container');
        const mainContainer = document.getElementById('main-container');
        const cssInput = document.getElementById('css-input');
        const convertButton = document.getElementById('convert-button');

        let uploadedFileContent = '';
        let coverImageFile = null;

        // 사용자 정의 메시지 박스 함수
        const showMessage = (text, type = 'info') => {
            messageBox.textContent = text;
            messageBox.className = 'p-4 rounded-xl text-sm w-full transition-all duration-300 ease-in-out';
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800', 'block');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800', 'block');
            } else { // info
                messageBox.classList.add('bg-gray-100', 'text-gray-800', 'block');
            }
        };

        // UI 상태 초기화
        const resetUI = () => {
            messageBox.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            downloadLinkContainer.classList.add('hidden');
            downloadLinkContainer.innerHTML = '';
            mainContainer.classList.add('hidden');
            previewArea.value = '';
        };

        // TXT 파일 선택 시 이벤트 리스너
        txtFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            resetUI();
            
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFileContent = e.target.result;
                previewArea.value = uploadedFileContent;
                mainContainer.classList.remove('hidden');
                showMessage(`파일이 정상적으로 업로드되었습니다: ${file.name}`, 'success');
            };
            reader.readAsText(file);
        });

        // 표지 이미지 파일 선택 시 이벤트 리스너
        coverImageInput.addEventListener('change', (event) => {
            coverImageFile = event.target.files[0];
            if (!coverImageFile) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                coverPreview.src = e.target.result;
                coverPreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(coverImageFile);
        });

        // 다운로드 링크를 DOM에 추가하는 함수
        const createDownloadLink = (url, fileName) => {
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.textContent = `다운로드: ${fileName}`;
            a.className = 'bg-green-500 text-white font-semibold py-2 px-4 rounded-xl shadow-md hover:bg-green-600';
            downloadLinkContainer.appendChild(a);
            downloadLinkContainer.classList.remove('hidden');
        };

        // EPUB 변환하기 버튼 클릭 이벤트
        convertButton.addEventListener('click', async () => {
            if (!uploadedFileContent) {
                showMessage('먼저 TXT 파일을 업로드해주세요.', 'error');
                return;
            }
            
            loadingSpinner.classList.remove('hidden');
            downloadLinkContainer.classList.add('hidden');
            downloadLinkContainer.innerHTML = '';
            showMessage('EPUB 파일을 생성하는 중입니다...', 'info');

            try {
                const zip = new JSZip();
                const fileName = txtFileInput.files[0].name.replace('.txt', '');
                
                const tocTitles = tocInput.value.split('\n').map(title => title.trim()).filter(title => title !== '');
                const chapters = [];
                
                // 목차 제목을 기준으로 텍스트를 챕터로 분할
                let lastIndex = 0;
                for (let i = 0; i < tocTitles.length; i++) {
                    const currentTitle = tocTitles[i];
                    const nextTitle = tocTitles[i + 1] || '';
                    const startIndex = uploadedFileContent.indexOf(currentTitle, lastIndex);
                    if (startIndex === -1) {
                        continue;
                    }
                    let endIndex = uploadedFileContent.length;
                    if (nextTitle) {
                        const nextIndex = uploadedFileContent.indexOf(nextTitle, startIndex + currentTitle.length);
                        if (nextIndex !== -1) {
                            endIndex = nextIndex;
                        }
                    }
                    chapters.push(uploadedFileContent.substring(startIndex, endIndex).trim());
                    lastIndex = endIndex;
                }

                if (chapters.length === 0 && uploadedFileContent.trim().length > 0) {
                     chapters.push(uploadedFileContent.trim());
                }

                // 텍스트 내용 전처리 함수
                const processText = (text) => {
                    // 줄바꿈을 <br/>로 변환하여 원본 줄바꿈 유지
                    let processed = text.replace(/\n/g, '<br/>');

                    // 별표(*) 및 세개(*) 굵게 + 가운데 정렬
                    processed = processed.replace(/^\s*(\*|\*\*\*)\s*$/gm, '<p class="star-separator"><b>$1</b></p>');

                    return processed;
                };

                // 1. EPUB 메타데이터 파일 생성 (content.opf)
                const opfContent = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="3.0">
    <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
        <dc:identifier id="bookid">urn:uuid:${crypto.randomUUID()}</dc:identifier>
        <dc:title>${fileName}</dc:title>
        <dc:creator>@Killua</dc:creator>
        <dc:language>ko</dc:language>
        <meta property="dcterms:modified">${new Date().toISOString().split('.')[0]}Z</meta>
        <meta name="cover" content="cover-image"/>
    </metadata>
    <manifest>
        <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
        <item id="css" href="style.css" media-type="text/css"/>
        <item id="cover" href="cover.xhtml" media-type="application/xhtml+xml" properties="cover-page"/>
        <item id="cover-image" href="cover.jpg" media-type="image/jpeg" properties="cover-image"/>
        ${chapters.map((_, i) => `<item id="chap${i + 1}" href="chap${i + 1}.xhtml" media-type="application/xhtml+xml"/>`).join('\n        ')}
    </manifest>
    <spine toc="ncx">
        <itemref idref="cover" linear="yes"/>
        ${chapters.map((_, i) => `<itemref idref="chap${i + 1}"/>`).join('\n        ')}
    </spine>
</package>`;

                // 2. 목차 파일 생성 (toc.ncx)
                const ncxContent = `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1" xml:lang="ko">
    <head>
        <meta name="dtb:uid" content="urn:uuid:${crypto.randomUUID()}"/>
        <meta name="dtb:depth" content="1"/>
        <meta name="dtb:totalPageCount" content="0"/>
        <meta name="dtb:maxPageNumber" content="0"/>
    </head>
    <docTitle><text>${fileName}</text></docTitle>
    <navMap>
        <navPoint id="navPoint-cover" playOrder="0">
            <navLabel><text>표지</text></navLabel>
            <content src="cover.xhtml"/>
        </navPoint>
        ${tocTitles.map((title, i) => `<navPoint id="navPoint-${i + 1}" playOrder="${i + 1}">
            <navLabel><text>${title}</text></navLabel>
            <content src="chap${i + 1}.xhtml"/>
        </navPoint>`).join('\n        ')}
    </navMap>
</ncx>`;

                // 3. 챕터별 XHTML 파일 생성
                const chapterXHTMLs = chapters.map((chapter, i) => {
                    const titleHtml = tocTitles[i] ? `<h1>${tocTitles[i]}</h1><br/><br/>` : ''; // 제목과 본문 사이 2칸 띄우기
                    const processedContentHtml = processText(chapter);
                    return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ko" lang="ko">
<head>
    <title>${tocTitles[i] || `Chapter ${i + 1}`}</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
    ${titleHtml}
    <p>${processedContentHtml}</p>
</body>
</html>`;
                });

                // 4. ZIP 파일에 필요한 모든 파일 추가
                zip.file("mimetype", "application/epub+zip", { compression: "STORE" });
                const containerXml = `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
    <rootfiles>
        <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
    </rootfiles>
</container>`;
                zip.folder("META-INF").file("container.xml", containerXml);
                const oebpsFolder = zip.folder("OEBPS");
                oebpsFolder.file("content.opf", opfContent);
                oebpsFolder.file("toc.ncx", ncxContent);
                oebpsFolder.file("style.css", cssInput.value);

                // 표지 이미지 및 XHTML 생성
                let coverXHTML = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ko" lang="ko">
<head>
    <title>${fileName} 표지</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body style="margin: 0; padding: 0;">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
        width="100%" height="100%" viewBox="0 0 960 1440" preserveAspectRatio="xMidYMid meet">
        <image width="960" height="1440" xlink:href="cover.jpg" />
    </svg>
</body>
</html>`;
                
                if (coverImageFile) {
                    const img = new Image();
                    img.src = URL.createObjectURL(coverImageFile);
                    await new Promise(resolve => img.onload = resolve);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 960;
                    canvas.height = 1440;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const resizedImageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                    const coverImageData = await resizedImageBlob.arrayBuffer();
                    oebpsFolder.file("cover.jpg", coverImageData);
                } else {
                    // 기본 표지 이미지 생성
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 960;
                    canvas.height = 1440;
                    ctx.fillStyle = '#f3f4f6';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#374151';
                    ctx.font = '40px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(fileName, canvas.width / 2, canvas.height / 2);
                    
                    const defaultCoverBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                    const defaultCoverData = await defaultCoverBlob.arrayBuffer();
                    oebpsFolder.file("cover.jpg", defaultCoverData);
                }
                oebpsFolder.file("cover.xhtml", coverXHTML);

                chapterXHTMLs.forEach((xhtml, i) => {
                    oebpsFolder.file(`chap${i + 1}.xhtml`, xhtml);
                });

                // 5. EPUB 파일 생성 및 다운로드
                const blob = await zip.generateAsync({ type: "blob", mimeType: "application/epub+zip" });
                const url = URL.createObjectURL(blob);
                
                loadingSpinner.classList.add('hidden');
                createDownloadLink(url, `${fileName}.epub`);
                showMessage('EPUB 파일이 성공적으로 생성되었습니다!', 'success');
            } catch (error) {
                loadingSpinner.classList.add('hidden');
                console.error("EPUB 생성 중 오류 발생:", error);
                showMessage('EPUB 생성 중 오류가 발생했습니다. 다시 시도해 주세요.', 'error');
            }
        });
    </script>
</body>
</html>
