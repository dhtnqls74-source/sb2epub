<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT to EPUB ë³€í™˜ê¸°</title>
    <!-- Tailwind CSS CDNì„ í¬í•¨í•˜ì—¬ ë¹ ë¥´ê²Œ ìŠ¤íƒ€ì¼ë§í•©ë‹ˆë‹¤. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            max-width: 32rem;
        }
        .file-upload-label {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="container bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 text-center mx-auto my-auto">
        <h1 class="text-2xl sm:text-3xl font-bold mb-4">
            TXT íŒŒì¼ì„ EPUBìœ¼ë¡œ ë³€í™˜í•˜ê¸°
        </h1>
        <p class="text-sm sm:text-base text-gray-600 mb-6">
            ë³€í™˜í•˜ë ¤ëŠ” .txt íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.
        </p>

        <!-- íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ -->
        <label for="txt-file-upload" class="file-upload-label inline-block bg-blue-500 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-blue-600">
            TXT íŒŒì¼ ì„ íƒ
        </label>
        <input id="txt-file-upload" type="file" accept=".txt" class="hidden" />

        <!-- ìƒíƒœ ë©”ì‹œì§€ ë° ë¡œë”© ìŠ¤í”¼ë„ˆ -->
        <div id="status-area" class="mt-8 flex flex-col items-center">
            <!-- ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ -->
            <div id="message-box" class="hidden p-4 rounded-xl text-sm w-full"></div>
            
            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
            <div id="loading-spinner" class="spinner hidden mt-4"></div>

            <!-- ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
            <div id="download-link-container" class="hidden mt-6"></div>
        </div>

        <!-- EPUB ì„¤ì • ë° ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
        <div id="main-container" class="hidden mt-8 text-left w-full">
            <!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ -->
            <div class="bg-gray-100 p-4 rounded-xl mb-6">
                <h2 class="text-xl font-bold mb-2">ğŸ“„ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</h2>
                <textarea id="preview-area" rows="10" class="w-full p-2 border rounded-md resize-none bg-white text-sm" readonly></textarea>
            </div>

            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center">ğŸ“šEPUB ì„¤ì •</h2>
            
            <!-- í‘œì§€ ì´ë¯¸ì§€ ì„ íƒ -->
            <div class="mb-6">
                <p class="text-gray-600 mb-2">EPUB í‘œì§€ ì´ë¯¸ì§€ ì„ íƒ</p>
                <label for="cover-image-upload" class="file-upload-label inline-block bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl shadow-sm hover:bg-gray-300">
                    ì´ë¯¸ì§€ ì„ íƒ
                </label>
                <input id="cover-image-upload" type="file" accept="image/*" class="hidden" />
                <div id="cover-preview-container" class="mt-4 p-4 bg-gray-100 rounded-xl hidden">
                    <p class="font-bold mb-2">ì„ íƒëœ í‘œì§€ ì´ë¯¸ì§€:</p>
                    <img id="cover-preview" class="w-full h-auto rounded-lg shadow-md max-h-80 object-contain mx-auto" src="" alt="í‘œì§€ ë¯¸ë¦¬ë³´ê¸°" />
                </div>
            </div>

            <!-- ëª©ì°¨ ì„¤ì • -->
            <div class="mb-6">
                <p class="text-gray-600 mb-2">ëª©ì°¨ ì„¤ì •</p>
                <textarea id="toc-input" rows="5" class="w-full p-4 border rounded-xl shadow-sm text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì±•í„° ì œëª©ì„ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”.&#10;ì˜ˆ:&#10;1ì¥. ìƒˆë¡œìš´ ì‹œì‘&#10;2ì¥. ëª¨í—˜ì˜ ì„œë§‰&#10;3ì¥. ì‹ ë¹„í•œ ì—¬ì •"></textarea>
            </div>

            <!-- EPUB ìŠ¤íƒ€ì¼ ì„¤ì • -->
            <div class="mb-6">
                <p class="text-gray-600 mb-2">EPUB CSS ìŠ¤íƒ€ì¼ ì„¤ì •</p>
                <textarea id="css-input" rows="8" class="w-full p-4 border rounded-xl shadow-sm text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="/* CSS ì½”ë“œë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”. */">
@page {
  margin: 0;
  padding: 0;
}
body {
  margin: 0;
  padding: 0;
}
h1 {
  font-size: 15pt;
  font-weight: bold;
  text-align: center;
  margin-top: 3em;
  margin-bottom: 3em;
}

p {
  line-height: 2em;
  text-align: justify;
  text-indent: 1em;
  font-size: 1.0em;
  font-weight: normal;
  padding-bottom: 0.4em;
}

.star-separator {
  text-align: center;
  font-weight: bold;
}
</textarea>
            </div>
            
            <!-- ìµœì¢… ë³€í™˜ ë²„íŠ¼ -->
            <button id="convert-button" class="w-full mt-4 bg-green-500 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-green-600 transition-colors">
                EPUB ë³€í™˜í•˜ê¸°
            </button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const txtFileInput = document.getElementById('txt-file-upload');
        const previewArea = document.getElementById('preview-area');
        const coverImageInput = document.getElementById('cover-image-upload');
        const coverPreviewContainer = document.getElementById('cover-preview-container');
        const coverPreview = document.getElementById('cover-preview');
        const tocInput = document.getElementById('toc-input');
        const statusArea = document.getElementById('status-area');
        const messageBox = document.getElementById('message-box');
        const loadingSpinner = document.getElementById('loading-spinner');
        const downloadLinkContainer = document.getElementById('download-link-container');
        const mainContainer = document.getElementById('main-container');
        const cssInput = document.getElementById('css-input');
        const convertButton = document.getElementById('convert-button');

        let uploadedFileContent = '';
        let coverImageFile = null;

        // ì‚¬ìš©ì ì •ì˜ ë©”ì‹œì§€ ë°•ìŠ¤ í•¨ìˆ˜
        const showMessage = (text, type = 'info') => {
            messageBox.textContent = text;
            messageBox.className = 'p-4 rounded-xl text-sm w-full transition-all duration-300 ease-in-out';
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800', 'block');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800', 'block');
            } else { // info
                messageBox.classList.add('bg-gray-100', 'text-gray-800', 'block');
            }
        };

        // UI ìƒíƒœ ì´ˆê¸°í™”
        const resetUI = () => {
            messageBox.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            downloadLinkContainer.classList.add('hidden');
            downloadLinkContainer.innerHTML = '';
            mainContainer.classList.add('hidden');
            previewArea.value = '';
        };

        // TXT íŒŒì¼ ì„ íƒ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        txtFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            resetUI();
            
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFileContent = e.target.result;
                previewArea.value = uploadedFileContent;
                mainContainer.classList.remove('hidden');
                showMessage(`íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: ${file.name}`, 'success');
            };
            reader.readAsText(file);
        });

        // í‘œì§€ ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        coverImageInput.addEventListener('change', (event) => {
            coverImageFile = event.target.files[0];
            if (!coverImageFile) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                coverPreview.src = e.target.result;
                coverPreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(coverImageFile);
        });

        // ë‹¤ìš´ë¡œë“œ ë§í¬ë¥¼ DOMì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        const createDownloadLink = (url, fileName) => {
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.textContent = `ë‹¤ìš´ë¡œë“œ: ${fileName}`;
            a.className = 'bg-green-500 text-white font-semibold py-2 px-4 rounded-xl shadow-md hover:bg-green-600';
            downloadLinkContainer.appendChild(a);
            downloadLinkContainer.classList.remove('hidden');
        };

        // EPUB ë³€í™˜í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        convertButton.addEventListener('click', async () => {
            if (!uploadedFileContent) {
                showMessage('ë¨¼ì € TXT íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            loadingSpinner.classList.remove('hidden');
            downloadLinkContainer.classList.add('hidden');
            downloadLinkContainer.innerHTML = '';
            showMessage('EPUB íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'info');

            try {
                const zip = new JSZip();
                const fileName = txtFileInput.files[0].name.replace('.txt', '');
                
                const tocTitles = tocInput.value.split('\n').map(title => title.trim()).filter(title => title !== '');
                const chapters = [];
                
                // ëª©ì°¨ ì œëª©ì„ ê¸°ì¤€ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¥¼ ì±•í„°ë¡œ ë¶„í• 
                let lastIndex = 0;
                for (let i = 0; i < tocTitles.length; i++) {
                    const currentTitle = tocTitles[i];
                    const nextTitle = tocTitles[i + 1] || '';
                    const startIndex = uploadedFileContent.indexOf(currentTitle, lastIndex);
                    if (startIndex === -1) {
                        continue;
                    }
                    let endIndex = uploadedFileContent.length;
                    if (nextTitle) {
                        const nextIndex = uploadedFileContent.indexOf(nextTitle, startIndex + currentTitle.length);
                        if (nextIndex !== -1) {
                            endIndex = nextIndex;
                        }
                    }
                    chapters.push(uploadedFileContent.substring(startIndex, endIndex).trim());
                    lastIndex = endIndex;
                }

                if (chapters.length === 0 && uploadedFileContent.trim().length > 0) {
                     chapters.push(uploadedFileContent.trim());
                }

                // í…ìŠ¤íŠ¸ ë‚´ìš© ì „ì²˜ë¦¬ í•¨ìˆ˜
                const processText = (text) => {
                    // ì¤„ë°”ê¿ˆì„ <br/>ë¡œ ë³€í™˜í•˜ì—¬ ì›ë³¸ ì¤„ë°”ê¿ˆ ìœ ì§€
                    let processed = text.replace(/\n/g, '<br/>');

                    // ë³„í‘œ(*) ë° ì„¸ê°œ(*) êµµê²Œ + ê°€ìš´ë° ì •ë ¬
                    processed = processed.replace(/^\s*(\*|\*\*\*)\s*$/gm, '<p class="star-separator"><b>$1</b></p>');

                    return processed;
                };

                // 1. EPUB ë©”íƒ€ë°ì´í„° íŒŒì¼ ìƒì„± (content.opf)
                const opfContent = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="3.0">
    <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
        <dc:identifier id="bookid">urn:uuid:${crypto.randomUUID()}</dc:identifier>
        <dc:title>${fileName}</dc:title>
        <dc:creator>@Killua</dc:creator>
        <dc:language>ko</dc:language>
        <meta property="dcterms:modified">${new Date().toISOString().split('.')[0]}Z</meta>
        <meta name="cover" content="cover-image"/>
    </metadata>
    <manifest>
        <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
        <item id="css" href="style.css" media-type="text/css"/>
        <item id="cover" href="cover.xhtml" media-type="application/xhtml+xml" properties="cover-page"/>
        <item id="cover-image" href="cover.jpg" media-type="image/jpeg" properties="cover-image"/>
        ${chapters.map((_, i) => `<item id="chap${i + 1}" href="chap${i + 1}.xhtml" media-type="application/xhtml+xml"/>`).join('\n        ')}
    </manifest>
    <spine toc="ncx">
        <itemref idref="cover" linear="yes"/>
        ${chapters.map((_, i) => `<itemref idref="chap${i + 1}"/>`).join('\n        ')}
    </spine>
</package>`;

                // 2. ëª©ì°¨ íŒŒì¼ ìƒì„± (toc.ncx)
                const ncxContent = `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1" xml:lang="ko">
    <head>
        <meta name="dtb:uid" content="urn:uuid:${crypto.randomUUID()}"/>
        <meta name="dtb:depth" content="1"/>
        <meta name="dtb:totalPageCount" content="0"/>
        <meta name="dtb:maxPageNumber" content="0"/>
    </head>
    <docTitle><text>${fileName}</text></docTitle>
    <navMap>
        <navPoint id="navPoint-cover" playOrder="0">
            <navLabel><text>í‘œì§€</text></navLabel>
            <content src="cover.xhtml"/>
        </navPoint>
        ${tocTitles.map((title, i) => `<navPoint id="navPoint-${i + 1}" playOrder="${i + 1}">
            <navLabel><text>${title}</text></navLabel>
            <content src="chap${i + 1}.xhtml"/>
        </navPoint>`).join('\n        ')}
    </navMap>
</ncx>`;

                // 3. ì±•í„°ë³„ XHTML íŒŒì¼ ìƒì„±
                const chapterXHTMLs = chapters.map((chapter, i) => {
                    const titleHtml = tocTitles[i] ? `<h1>${tocTitles[i]}</h1><br/><br/>` : ''; // ì œëª©ê³¼ ë³¸ë¬¸ ì‚¬ì´ 2ì¹¸ ë„ìš°ê¸°
                    const processedContentHtml = processText(chapter);
                    return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ko" lang="ko">
<head>
    <title>${tocTitles[i] || `Chapter ${i + 1}`}</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
    ${titleHtml}
    <p>${processedContentHtml}</p>
</body>
</html>`;
                });

                // 4. ZIP íŒŒì¼ì— í•„ìš”í•œ ëª¨ë“  íŒŒì¼ ì¶”ê°€
                zip.file("mimetype", "application/epub+zip", { compression: "STORE" });
                const containerXml = `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
    <rootfiles>
        <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
    </rootfiles>
</container>`;
                zip.folder("META-INF").file("container.xml", containerXml);
                const oebpsFolder = zip.folder("OEBPS");
                oebpsFolder.file("content.opf", opfContent);
                oebpsFolder.file("toc.ncx", ncxContent);
                oebpsFolder.file("style.css", cssInput.value);

                // í‘œì§€ ì´ë¯¸ì§€ ë° XHTML ìƒì„±
                let coverXHTML = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ko" lang="ko">
<head>
    <title>${fileName} í‘œì§€</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body style="margin: 0; padding: 0;">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
        width="100%" height="100%" viewBox="0 0 960 1440" preserveAspectRatio="xMidYMid meet">
        <image width="960" height="1440" xlink:href="cover.jpg" />
    </svg>
</body>
</html>`;
                
                if (coverImageFile) {
                    const img = new Image();
                    img.src = URL.createObjectURL(coverImageFile);
                    await new Promise(resolve => img.onload = resolve);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 960;
                    canvas.height = 1440;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const resizedImageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                    const coverImageData = await resizedImageBlob.arrayBuffer();
                    oebpsFolder.file("cover.jpg", coverImageData);
                } else {
                    // ê¸°ë³¸ í‘œì§€ ì´ë¯¸ì§€ ìƒì„±
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 960;
                    canvas.height = 1440;
                    ctx.fillStyle = '#f3f4f6';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#374151';
                    ctx.font = '40px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(fileName, canvas.width / 2, canvas.height / 2);
                    
                    const defaultCoverBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                    const defaultCoverData = await defaultCoverBlob.arrayBuffer();
                    oebpsFolder.file("cover.jpg", defaultCoverData);
                }
                oebpsFolder.file("cover.xhtml", coverXHTML);

                chapterXHTMLs.forEach((xhtml, i) => {
                    oebpsFolder.file(`chap${i + 1}.xhtml`, xhtml);
                });

                // 5. EPUB íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                const blob = await zip.generateAsync({ type: "blob", mimeType: "application/epub+zip" });
                const url = URL.createObjectURL(blob);
                
                loadingSpinner.classList.add('hidden');
                createDownloadLink(url, `${fileName}.epub`);
                showMessage('EPUB íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                loadingSpinner.classList.add('hidden');
                console.error("EPUB ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                showMessage('EPUB ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
            }
        });
    </script>
</body>
</html>
